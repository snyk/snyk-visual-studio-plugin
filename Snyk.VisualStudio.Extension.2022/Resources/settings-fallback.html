<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Snyk Settings</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            font-size: 13px;
            color: {{TEXT_COLOR}};
            background-color: {{BACKGROUND_COLOR}};
            padding: 20px;
            line-height: 1.6;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
        }

        h1 {
            font-size: 24px;
            margin-bottom: 10px;
            font-weight: 600;
        }

        h2 {
            font-size: 18px;
            margin: 30px 0 15px 0;
            font-weight: 600;
            border-bottom: 1px solid {{BORDER_COLOR}};
            padding-bottom: 8px;
        }

        .info-banner {
            background-color: {{INFO_BG_COLOR}};
            border-left: 4px solid {{INFO_BORDER_COLOR}};
            padding: 12px 16px;
            margin: 20px 0;
        }

        .info-banner p {
            margin: 8px 0;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 6px;
            font-weight: 500;
        }

        input[type="text"],
        select {
            width: 100%;
            padding: 8px 12px;
            background-color: {{INPUT_BACKGROUND}};
            color: {{INPUT_FOREGROUND}};
            border: 1px solid {{INPUT_BORDER}};
            font-family: inherit;
            font-size: inherit;
        }

        input[type="text"]:focus,
        select:focus {
            outline: none;
            border-color: {{FOCUS_BORDER}};
        }

        input[type="checkbox"] {
            margin-right: 8px;
            cursor: pointer;
        }

        .checkbox-group {
            margin-bottom: 12px;
        }

        .checkbox-group label {
            margin: 0;
            font-weight: 400;
            cursor: pointer;
            display: inline;
        }

        .help-text {
            font-size: 12px;
            color: {{TEXT_COLOR}};
            opacity: 0.7;
            margin-top: 4px;
        }

        .error-message {
            background-color: {{ERROR_BG_COLOR}};
            border-left: 4px solid {{ERROR_BORDER_COLOR}};
            padding: 12px 16px;
            margin: 20px 0;
            display: none;
        }

        .error-message.visible {
            display: block;
        }

        .error-message p {
            color: {{ERROR_TEXT_COLOR}};
            font-weight: 500;
        }

        .divider {
            height: 1px;
            background-color: {{BORDER_COLOR}};
            margin: 30px 0;
        }

        .section-description {
            margin-bottom: 20px;
            opacity: 0.8;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Snyk Settings</h1>

        <div class="info-banner">
            <p><strong>Download Snyk CLI to unlock full settings</strong></p>
            <p>The full configuration interface is only available when the Snyk Language Server is running.
               Download the Snyk CLI below to enable all settings.</p>
        </div>

        <div class="error-message" id="errorMessage">
            <p id="errorText"></p>
        </div>

        <form id="settingsForm">
            <h2>Snyk CLI</h2>
            <p class="section-description">Configure how Snyk CLI binaries are managed and downloaded.</p>

            <div class="form-group">
                <div class="checkbox-group">
                    <input type="checkbox" id="manageBinaries" name="manageBinaries" {{MANAGE_BINARIES_CHECKED}}>
                    <label for="manageBinaries">Manage binaries automatically</label>
                </div>
                <p class="help-text">Let Snyk automatically download and update the CLI binary</p>
            </div>

            <div class="form-group">
                <label for="cliPath">CLI Path</label>
                <input type="text" id="cliPath" name="cliPath" value="{{CLI_PATH}}" placeholder="Path to Snyk CLI executable">
                <p class="help-text">Specify a custom path to the Snyk CLI executable (leave empty for automatic management)</p>
            </div>

            <div class="form-group">
                <label for="baseDownloadUrl">Base Download URL</label>
                <input type="text" id="baseDownloadUrl" name="baseDownloadUrl" value="{{CLI_BASE_DOWNLOAD_URL}}" placeholder="https://downloads.snyk.io">
                <p class="help-text">Custom base URL for downloading Snyk CLI (for enterprise proxy setups)</p>
            </div>

            <div class="form-group">
                <label for="releaseChannel">Release Channel</label>
                <select id="releaseChannel" name="releaseChannel">
                    <option value="stable" {{CHANNEL_STABLE_SELECTED}}>Stable</option>
                    <option value="rc" {{CHANNEL_RC_SELECTED}}>Release Candidate</option>
                    <option value="preview" {{CHANNEL_PREVIEW_SELECTED}}>Preview</option>
                </select>
                <p class="help-text">Choose which release channel to use for CLI updates</p>
            </div>

            <div class="divider"></div>

            <h2>About</h2>
            <p class="section-description">
                This is a minimal configuration interface. To access all Snyk settings including scan types,
                severity filters, and authentication options, please ensure the Snyk Language Server is running
                by downloading the CLI above.
            </p>
        </form>
    </div>

    <script type="text/javascript">
        // IE11-compatible JavaScript (ES5 only)
        (function() {
            'use strict';

            // Track form changes
            var isFormDirty = false;
            var form = document.getElementById('settingsForm');

            // Use traditional event handling for IE11
            if (form.addEventListener) {
                form.addEventListener('change', onFormChange, false);
            } else {
                form.attachEvent('onchange', onFormChange);
            }

            function onFormChange() {
                isFormDirty = true;
                if (window.external && window.external.OnFormDirtyChange) {
                    window.external.OnFormDirtyChange(true);
                }
            }

            // Collect and save configuration
            window.getAndSaveIdeConfig = function() {
                if (!isFormDirty) {
                    return;
                }

                try {
                    var config = {
                        manageBinariesAutomatically: document.getElementById('manageBinaries').checked,
                        cliPath: document.getElementById('cliPath').value.replace(/^\s+|\s+$/g, ''), // trim
                        cliBaseDownloadURL: document.getElementById('baseDownloadUrl').value.replace(/^\s+|\s+$/g, ''),
                        cliReleaseChannel: document.getElementById('releaseChannel').value
                    };

                    // Call C# bridge function via ObjectForScripting
                    if (window.external && window.external.SaveIdeConfig) {
                        window.external.SaveIdeConfig(JSON.stringify(config));
                        isFormDirty = false;
                        if (window.external.OnFormDirtyChange) {
                            window.external.OnFormDirtyChange(false);
                        }
                        hideError();
                    } else {
                        showError('Unable to save settings: IDE bridge not available');
                    }
                } catch (error) {
                    showError('Error saving settings: ' + error.message);
                }
            };

            // Error handling helpers
            function showError(message) {
                var errorDiv = document.getElementById('errorMessage');
                var errorText = document.getElementById('errorText');
                if (errorDiv && errorText) {
                    errorText.innerText = message; // Use innerText for IE11
                    errorDiv.className = errorDiv.className + ' visible';
                }
            }

            function hideError() {
                var errorDiv = document.getElementById('errorMessage');
                if (errorDiv) {
                    errorDiv.className = errorDiv.className.replace(' visible', '');
                }
            }

            // Make error functions globally available
            window.showError = showError;
            window.hideError = hideError;

            // Auto-enable CLI path input when manage binaries is unchecked
            var manageBinariesCheckbox = document.getElementById('manageBinaries');
            var cliPathInput = document.getElementById('cliPath');

            function updateCliPathState() {
                if (manageBinariesCheckbox.checked) {
                    cliPathInput.disabled = true;
                    cliPathInput.style.opacity = '0.5';
                } else {
                    cliPathInput.disabled = false;
                    cliPathInput.style.opacity = '1';
                }
            }

            if (manageBinariesCheckbox.addEventListener) {
                manageBinariesCheckbox.addEventListener('change', updateCliPathState, false);
            } else {
                manageBinariesCheckbox.attachEvent('onchange', updateCliPathState);
            }
            updateCliPathState(); // Initialize state

        })();
    </script>
</body>
</html>
